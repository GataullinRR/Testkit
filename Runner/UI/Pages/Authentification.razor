@page "/auth";
@inject IMapper Mapper;
@inject UserService.UserServiceClient UserService;
@inject IMessageService MessageService;
@inject ICookieStorage Cookies;
@inject NavigationManager NavigationManager;
@inject IUserChangeNotifier UserChangeNotifier;

@if (_signIn)
{
    <SignInForm OnSubmit="loginAsync" OnRegistrationRequest="registrationRequested"></SignInForm>
}
else
{
    <SignUpForm OnSubmit="registerAsync" OnSignInRequest="signInRequested"></SignUpForm>
}

@code {
    public static string BuildPath()
    {
        return $"/auth";
    }

    bool _signIn = true;

    void registrationRequested()
    {
        _signIn = false;

        StateHasChanged();
    }

    void signInRequested()
    {
        _signIn = true;

        StateHasChanged();
    }

    async void registerAsync(SignUpForm.SignUpPresentationModel model)
    {
        var request = Mapper.Map<SignUpRequest>(model);
        var response = await UserService.SignUpAsync(request);
        if (response.Status.Code == StatusCode.Ok)
        {
            MessageService.AddMessage("You've been succesfully registered, now you can sign in!");

            signInRequested();
        }
        else
        {
            if (response.Status.Description == null)
            {
                MessageService.AddMessage("Ooops! Could not perform operation requested  :(");
            }
            else
            {
                MessageService.AddMessage(response.Status.Description);
            }
        }
    }

    async void loginAsync(SignInForm.SignInPresentationModel model)
    {
        var request = Mapper.Map<SignInRequest>(model);
        var response = await UserService.SignInAsync(request);
        if (response.Status.Code == StatusCode.Ok)
        {
            await Cookies.SetAsync(Constants.AUTH_TOKEN_COOKIE, response.Token);
            await UserChangeNotifier.FireAuthStateChangedAsync();

            MessageService.AddMessage($"Hi, {model.UserName}!");

            NavigationManager.NavigateTo(Runner.UI.Pages.Index.URI);
        }
        else
        {
            if (response.Status.Description == null)
            {
                MessageService.AddMessage("Ooops! Could not perform operation requested  :(");
            }
            else
            {
                MessageService.AddMessage(response.Status.Description);
            }
        }
    }
}
