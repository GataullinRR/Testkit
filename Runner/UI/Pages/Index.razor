@inject PresentationService.API2.PresentationService.PresentationServiceClient PresentationServiceCleint;
@inject JsonSerializerSettings JsonSettings;
@inject ICookieStorage Cookies;
@inject IMessageService Messages;
@inject NavigationManager NavigationManager
@inject IAppInitializationAwaiter AppInitializer;
@page "/"

<TestsTable Tests="_tests" TotalCount="_totalCount" OnAddRequestedAsync="onShowMoreAsync"></TestsTable>

@code {
    public const string URI = "/";

    int _totalCount;
    TestInfo[] _tests;

    protected override async Task OnInitializedAsync()
    {
        await AppInitializer.AwaitInitializedAsync();

        await addTestsAsync(0, 10);
    }

    async Task addTestsAsync(int from, int to)
    {
        var response = await PresentationServiceCleint.ListTestsAsync(new PresentationService.API2.ListTestsRequest()
        {
            Token = await Cookies.GetValueAsync(Constants.AUTH_TOKEN_COOKIE) ?? "",
            Range = new UIntRange() { From = from.ToUInt32(), To = to.ToUInt32() }
        });
        var text = response.TestInfos.ToStringUtf8();
        var newTests = JsonConvert.DeserializeObject<TestInfo[]>(text, JsonSettings);
        _totalCount = response.TotalCount.ToInt32();

        _tests = _tests == null
            ? newTests
            : _tests.Concat(newTests).ToArray();
    }

    async Task onShowMoreAsync(int count)
    {
        await addTestsAsync(_tests.Length, _tests.Length + count);

        StateHasChanged();
    }
}

