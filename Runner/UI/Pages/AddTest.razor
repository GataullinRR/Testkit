@inject IPresentationService PresentationService;
@inject ICookieStorage Cookies;
@inject IIdentityContext Context;
@inject IMessageService Messages;
@inject IWebMessageHub MessageHub;
@page "/add-case"

<RootContainer>
    <CascadingValue Name="IsDisabled" Value="!_isReady">
        <FormTemplate Model="_model" OnSubmit="onSubmit">
            <FormHeader Name="Lookup parameters" />
            <FormTextInput Name="ServiceId" @bind-Value="_model.ServiceId" />
            <FormTextInput Name="UserId" @bind-Value="_model.UserId" />

            <FormValidator />

            <FormButton IsSubmit="true" Name="Show" />
        </FormTemplate>
    </CascadingValue>
</RootContainer>

<UnsavedRecordedTestsView Parameters="_testParameters" />

@code {
    public static string BuildPath()
    {
        return $"/add-case";
    }

    class LookupParameters
    {
        public string ServiceId { get; set; }

        public string UserId { get; set; }
    }

    Dictionary<string, string> _testParameters = new Dictionary<string, string>();

    bool _isReady = false;
    readonly LookupParameters _model = new LookupParameters();

    async void onSubmit()
    {
        _isReady = false;
        _testParameters = new Dictionary<string, string>()
        {
            { nameof(LookupParameters.UserId), _model.UserId.IsNullOrEmpty() ? null : _model.UserId },
            { nameof(LookupParameters.ServiceId), _model.ServiceId.IsNullOrEmpty() ? null : _model.ServiceId  },
        };
        StateHasChanged();

        await updateAsync();
    }

    protected override async Task OnParametersSetAsync()
    {
        await updateAsync();

        await base.OnParametersSetAsync();
    }

    async Task updateAsync()
    {
        _isReady = true;
        StateHasChanged();
    }

    protected override Task OnInitializedAsync()
    {
        return base.OnInitializedAsync();
    }
}
